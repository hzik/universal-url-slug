<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Universal URL Slug</title>
    <!-- Include jQuery library -->
	<script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
	
    <!-- Include the Custom Elements API-->
    <script src="https://app.kontent.ai/js-api/custom-element.js"></script>
	<link rel="stylesheet" href="./custom-element.css" />

    <!-- Custom element CSS styles -->
    <style>
		/* We recommended you always set margin to zero to avoid problems when displaying the element in UI */
		@import url(https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,400italic,700italic);
		html{
		  font-family:sans-serif;
		  -ms-text-size-adjust:100%;
		  -webkit-text-size-adjust:100%;
		}
		body {
			margin: 0;
			overflow-y: hidden;
			overflow-x: hidden;
		}
		
		[contenteditable=true]:empty:before{
			content: attr(placeholder);
			color: #aaa;
			display: block; /* For Firefox */
		}

		.disabled_overlay {
			position: fixed;
			background-color: #777;
			z-index: 10;
			cursor: not-allowed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			opacity: 0.1;
		}
    </style>
</head>
<body>
	<div class="text-field text-field--has-button" id="element">
		<div class="text-field__input u-transparent-border u-no-left-padding">
			<div id="slug" class="notranslate public-DraftEditor-content" contenteditable="true" placeholder="Enter slug here..." role="textbox" spellcheck="false" style="outline: none; user-select: text; overflow-wrap: break-word;"></div>
		</div>
		<div id="regenerate" class="text-field__button-pane">
			<div class="text-field__button">
				<div class="text-field__button-icon">
					<i class="icon-autogenerate" id="autogenerate" title="Autogenerate"></i>
				</div>
			</div>
		</div>
	</div>
	<div id="status" class="item-status"></div>
<script>	
	var generates_from = '';
	var autogenerate = '[autogenerated]';
	var restricted_chars = '[^a-zA-Z0-9]';

	function updateDisabled(disabled) {
		if (disabled) {
			$('.disabled_overlay').show();
		}
		else {
			$('.disabled_overlay').hide();
		}
	}
	
	function setup(value) {	
		setValue(value);	
		
		$('body').on('input', '[contenteditable]', function() {
			autogenerate = '[manual]';			
			var output = [$('#slug').text(),autogenerate];
			CustomElement.setValue(JSON.stringify(output));
			showType();		
		});
		$("#autogenerate").on( "click", function() {
			autogenerate = '[autogenerated]';
			returnValue(generates_from);
		});
	}
  
	function updateSize() {
		var height = 100;
		try {
			height = parseInt($("html").height());		
		} catch (err) {
			console.error(err);
		}
		CustomElement.setHeight(height);
	}
  
	function initCustomElement() {
		try {
			CustomElement.init((element, _context) => {
				// Setup with initial value and disabled state
				if (element.config) {
					if (element.config.generates_from) {
						generates_from = element.config.generates_from;
					}
					else {
						showError("Missing source 'Text' element codename");
					}
					if (element.config.restricted_chars) {
						restricted_chars = element.config.restricted_chars;
					}
				}
				
				if (element.value) {				
					autogenerate = JSON.parse(element.value)[1];				
					setup(JSON.parse(element.value)[0]);		
				}	
				else {
					setup("");
				}
				
				updateDisabled(element.disabled);
				updateSize();
			});
			// React when the disabled state changes (e.g. when publishing the item)
			CustomElement.onDisabledChanged(updateDisabled);
		} catch (err) {
			// Initialization with the Custom elements API failed 
			// (page displayed outside of the Kentico Cloud UI)
			console.error(err);
			updateDisabled(true);
		}
	}
  
	initCustomElement();	
		
	CustomElement.observeElementChanges([], (changedElementCodenames) => {
		if (changedElementCodenames[0] == generates_from && autogenerate != '[manual]') {
			returnValue(changedElementCodenames[0]);
		}
	})

	function returnValue(codename) {
		CustomElement.getElementValue(codename, (value) => {
			setValue(value);
			console.log(value);
			var output = [value,autogenerate];
			CustomElement.setValue(JSON.stringify(output));
			showType();		
		});
	}
	
	function setValue(value) {	
		var re = new RegExp(restricted_chars,"g");
		value = value.replace(re,'-');
		$('#slug').text(value);	
		showType();		
	}
		
	function showError(message) {
		$('#element').hide();
		$('#status').css("color","#ef5350");
		$('#status').addClass("item-status--failed");						
		$('#status').text(message);		
		throw new Error(message);
	}
		
	function showType() {
		$('#status').addClass("item-status--is-successful");	
		$('#status').text(autogenerate);
	}

</script>

</body>
</html>